<UserControl
    x:Class="Dynamo.UI.Controls.NodeAutoCompleteSearchControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:p="clr-namespace:Dynamo.Wpf.Properties"
    xmlns:resx="clr-namespace:Dynamo.Properties;assembly=DynamoCore"
    xmlns:ui="clr-namespace:Dynamo.UI"
    xmlns:uicontrols="clr-namespace:Dynamo.UI.Controls"
    MinWidth="280"
    MaxWidth="400"
    IsVisibleChanged="OnNodeAutoCompleteSearchControlVisibilityChanged"
    mc:Ignorable="d">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Dynamo.Wpf;component/Themes/Modern/Generic.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <Style
                x:Key="SearchMemberStyle"
                BasedOn="{StaticResource MemberGroupMemberStyle}"
                TargetType="{x:Type ListBoxItem}">
                <EventSetter Event="PreviewMouseLeftButtonUp" Handler="OnMouseLeftButtonUp" />
                <EventSetter Event="MouseEnter" Handler="OnMouseEnter" />
                <EventSetter Event="MouseLeave" Handler="OnMouseLeave" />
                <EventSetter Event="MouseMove" Handler="OnMouseMove" />
            </Style>

            <Style BasedOn="{StaticResource LibraryScrollViewerStyle}" TargetType="{x:Type ScrollViewer}">
                <Setter Property="Template" Value="{StaticResource LibraryScrollViewerControlTemplate}" />
            </Style>
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Border
            Margin="0"
            Panel.ZIndex="1"
            BorderBrush="{StaticResource WorkspaceBackgroundHomeBrush}"
            BorderThickness="1"
            CornerRadius="7,7,0,0"
            IsHitTestVisible="False" />

        <Grid PreviewKeyDown="OnInCanvasSearchKeyDown">
            <Grid.RowDefinitions>
                <RowDefinition Height="35" />
                <RowDefinition Height="*" />
                <RowDefinition Height="45" />
            </Grid.RowDefinitions>

            <Grid Name="Header" Grid.Row="0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Border Background="{StaticResource DarkMidGreyBrush}" CornerRadius="8,8,0,0">
                    <Grid Name="HeaderContent">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <TextBlock
                            Grid.Column="1"
                            Margin="0,5,0,5"
                            Padding="4"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Top"
                            Background="Transparent"
                            FontSize="14"
                            Foreground="{StaticResource AutocompletionWindowFontColor}"
                            Text="{x:Static resx:Resources.Autocomplete}"
                            TextWrapping="Wrap" />
                        <Image
                            Name="NodeAutoCompleteInfoIcon"
                            Grid.Column="2"
                            Width="14"
                            Height="14"
                            Margin="0,5,35,5"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"
                            MouseDown="OnMoreInfoClicked"
                            Style="{StaticResource ToggleInfoStyle}" />
                        <Image
                            Grid.Column="2"
                            Width="14"
                            Height="14"
                            Margin="0,5,10,5"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"
                            MouseDown="CloseAutocompletionWindow">
                            <Image.Style>
                                <Style TargetType="{x:Type Image}">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="False">
                                            <Setter Property="Source" Value="/Dynamo.Wpf;component/Assets/Images/TitleBarButtons/close-darktheme-default-16px.png" />
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Source" Value="/Dynamo.Wpf;component/Assets/Images/TitleBarButtons/close-darktheme-hover-16px.png" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                    </Grid>
                </Border>
            </Grid>

            <StackPanel
                Grid.Row="1"
                Width="{Binding Source={x:Static resx:Resources.Autocomplete}, Converter={StaticResource NodeAutocompleteWidthConverter}}"
                Background="{StaticResource LibraryCommonBackground}">
                <Border
                    Grid.Row="1"
                    MaxHeight="270"
                    Background="{StaticResource LibraryCommonBackground}">
                    <ListBox
                        Name="MembersListBox"
                        Margin="5"
                        HorizontalAlignment="Left"
                        Background="Transparent"
                        BorderBrush="Transparent"
                        ItemContainerStyle="{StaticResource SearchMemberStyle}"
                        ItemsSource="{Binding FilteredResults, NotifyOnTargetUpdated=True}"
                        PreviewMouseWheel="OnMembersListBoxMouseWheel"
                        TargetUpdated="OnMembersListBoxUpdated"
                        Visibility="Visible">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <ScrollViewer
                                    Width="{Binding Source={x:Static resx:Resources.Autocomplete}, Converter={StaticResource NodeAutocompleteWidthConverter}}"
                                    CanContentScroll="True"
                                    Style="{StaticResource InCanvasScrollViewerStyle}"
                                    Template="{StaticResource InCanvasScrollViewerControlTemplate}">
                                    <ContentPresenter ContentTemplate="{StaticResource MemberTemplate}" />
                                </ScrollViewer>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Border>
              
                <StackPanel
                    x:Name="LowConfidenceSpace"
                    Margin="0,10,0,20"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    MouseLeftButtonUp="ShowLowConfidenceResults"
                    Orientation="Horizontal"
                    Visibility="{Binding Path=DisplayLowConfidence, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Image
                        Width="14"
                        Height="14"
                        Margin="18,0,15,0"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Source="pack://application:,,,/Dynamo.Wpf;component/Assets/Images/caret_down.png" />
                    <TextBlock
                        HorizontalAlignment="Left"
                        FontSize="14"
                        Foreground="{StaticResource DynamoStandardLabelTextBrush}"
                        Text="{x:Static resx:Resources.AutocompleteLowConfidenceTitle}" />
                    <Image
                        Grid.Column="0"
                        Width="14"
                        Height="14"
                        Margin="10,0,0,0"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Style="{StaticResource ToggleInfoStyle}"
                        ToolTipService.ShowDuration="10000">
                        <Image.ToolTip>
                            <ToolTip Content="{x:Static resx:Resources.AutocompleteLowConfidenceTooltip}" Style="{StaticResource GenericToolTipLight}" />
                        </Image.ToolTip>
                    </Image>
                </StackPanel>
            </StackPanel>

            <Border
                Grid.RowSpan="2"
                BorderBrush="white"
                BorderThickness="0,0,0,1">
                <Popup
                    x:Name="toolTipPopup"
                    AllowsTransparency="True"
                    Placement="Right"
                    StaysOpen="True">
                    <!--<uicontrols:ToolTipWindow />-->
                </Popup>
            </Border>
            <Popup
                Name="confidenceToolTip"
                Width="250"
                Height="auto"
                Margin="50,-10,0,0"
                AllowsTransparency="True"
                PopupAnimation="Fade"
                StaysOpen="True">
                <Grid x:Name="ShadowBackground" Background="Transparent">
                    <Path
                        Width="20"
                        Height="6"
                        Margin="5,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Data="M0,6 L6,0 12,6Z"
                        Fill="{StaticResource objectLabelBackground}"
                        Stretch="None"
                        Stroke="{StaticResource CustomToolTipBorderColor}" />
                    <Path
                        Width="30"
                        Height="6"
                        Margin="5,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Data="M12 6 L26 6 L26 0 L4 0"
                        Fill="{StaticResource LibraryCommonBackground}"
                        Stretch="None" />
                    <Border
                        Margin="0,5,7,7"
                        Padding="10,8"
                        Background="{StaticResource objectLabelBackground}"
                        BorderBrush="{StaticResource CustomToolTipBorderColor}"
                        BorderThickness="1,0,1,1"
                        CornerRadius="2"
                        MouseLeftButtonUp="onCloseConfidenceToolTip">
                        <StackPanel Margin="3">
                            <TextBlock
                                Name="confidenceScoreTitle"
                                Margin="0,0,0,10"
                                Style="{StaticResource TextBlockToolTipTitle}" />
                            <TextBlock
                                Margin="0,0,0,10"
                                LineHeight="14px"
                                TextWrapping="Wrap">
                                <TextBlock.Inlines>
                                    <Run Style="{StaticResource TextBlockToolTipDescription}" Text="{x:Static p:Resources.ConfidenceToolTipDescription}" />
                                </TextBlock.Inlines>
                            </TextBlock>
                            <TextBlock
                                Name="confidenceLearnMore"
                                HorizontalAlignment="Right"
                                VerticalAlignment="Center"
                                MouseLeftButtonDown="onConfidenceToolTipLearnMoreClicked"
                                Style="{StaticResource TextBlockLinkDark}"
                                Text="{x:Static p:Resources.ConfidenceToolTipoLearnMore}" />
                        </StackPanel>
                    </Border>
                    <Border
                        Height="7"
                        Margin="16,5,9,0"
                        HorizontalAlignment="Stretch"
                        VerticalAlignment="Top"
                        BorderBrush="#999999"
                        BorderThickness="0,1,0,0"
                        CornerRadius="0 0 2 0" />
                    <Border
                        Width="6"
                        Height="7"
                        Margin="0,5,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        BorderBrush="#999999"
                        BorderThickness="0,1,0,0"
                        CornerRadius="2 0 0 0" />
                </Grid>
            </Popup>

            <Grid
                Name="SearchText"
                Grid.Row="2"
                Background="{StaticResource LibraryCommonBackground}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Border
                    Grid.Column="0"
                    Margin="8,8,0,8"
                    Padding="5"
                    Background="{StaticResource WorkspaceBackgroundHomeBrush}"
                    BorderThickness="1"
                    CornerRadius="5">
                    <Grid>
                        <StackPanel
                            Name="SearchIconAndTextBlockGrid"
                            Grid.ColumnSpan="2"
                            Width="Auto"
                            Orientation="Horizontal">
                            <Image
                                x:Name="SearchIcon"
                                Width="18"
                                Height="14"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center">
                                <Image.Style>
                                    <Style TargetType="{x:Type Image}">
                                        <Setter Property="Source" Value="/Dynamo.Wpf;component/Assets/Images/search_normal.png" />
                                    </Style>
                                </Image.Style>
                            </Image>

                            <TextBlock
                                Name="SearchTextBlock"
                                Height="14"
                                MaxWidth="250"
                                HorizontalAlignment="Left"
                                VerticalAlignment="Center"
                                FontSize="12"
                                Foreground="{StaticResource LightMidGreyBrush}"
                                IsHitTestVisible="False"
                                Text="{x:Static resx:Resources.AutocompleteSearchTextBlockText}"
                                TextTrimming="CharacterEllipsis"
                                Visibility="{Binding Path=SearchText, Converter={StaticResource NonEmptyStringToCollapsedConverter}}" />
                        </StackPanel>

                        <TextBox
                            Name="SearchTextBox"
                            Height="14"
                            MinWidth="200"
                            Margin="15,0,10,0"
                            VerticalAlignment="Center"
                            Background="Transparent"
                            BorderThickness="0"
                            CaretBrush="{StaticResource WorkspaceBackgroundBrush}"
                            FontSize="12"
                            Foreground="{StaticResource DarkerGreyBrush}"
                            IsEnabled="True"
                            Text="{Binding Path=SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            TextChanged="OnSearchTextBoxTextChanged" />
                    </Grid>
                </Border>

                <Button
                    x:Name="btnSuggestions"
                    Grid.Column="1"
                    Click="DisplaySuggestions">
                    <Button.ToolTip>
                        <ToolTip Content="{x:Static p:Resources.PreferencesNodeAutocompleteMethod}" Style="{StaticResource GenericToolTipLight}" />
                    </Button.ToolTip>
                    <Button.Style>
                        <Style TargetType="{x:Type Button}">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="{x:Type Button}">
                                        <Grid>
                                            <Border
                                                x:Name="DotsBackgroundBorder"
                                                Background="Transparent"
                                                CornerRadius="2" />
                                            <Image
                                                x:Name="DotsImage"
                                                Width="16px"
                                                Height="16px"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Stretch="UniformToFill" />
                                        </Grid>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="DotsBackgroundBorder" Property="Background" Value="{StaticResource NodeOptionsButtonBackground}" />
                                                <Setter TargetName="DotsImage" Property="Source" Value="/Dynamo.Wpf;component/Assets/Images/switch-hover-16px.png" />
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="False">
                                                <Setter TargetName="DotsBackgroundBorder" Property="Background" Value="Transparent" />
                                                <Setter TargetName="DotsImage" Property="Source" Value="/Dynamo.Wpf;component/Assets/Images/switch.png" />
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>
                <Grid.ContextMenu>
                    <ContextMenu Name="SuggestionsContextMenu" Style="{StaticResource ContextMenuStyle}">
                        <MenuItem
                            x:Name="miMLRecommendation"
                            Click="OnSuggestion_Click"
                            Header="{x:Static p:Resources.RecommendedNodes}"
                            IsCheckable="{Binding Path=IsMLAutocompleteTOUApproved, Mode=OneWay}"
                            IsChecked="{Binding Path=IsDisplayingMLRecommendation, Mode=OneWay, Converter={StaticResource BinaryRadioButtonCheckedConverter}, ConverterParameter=True}"
                            Visibility="{Binding HideAutocompleteMethodOptions, Converter={StaticResource InverseBoolToVisibilityCollapsedConverter}}" />
                        <MenuItem
                            x:Name="miObjectType"
                            Click="OnSuggestion_Click"
                            Header="{x:Static p:Resources.ObjectType}"
                            IsCheckable="True"
                            IsChecked="{Binding Path=IsDisplayingMLRecommendation, Mode=OneWay, Converter={StaticResource BinaryRadioButtonCheckedConverter}, ConverterParameter=False}" />
                    </ContextMenu>
                </Grid.ContextMenu>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
